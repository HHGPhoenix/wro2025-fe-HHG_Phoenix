<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LIDAR Polar Scatter Plot</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <canvas id="polarPlot" width="400" height="400"></canvas>
        <script>
            async function fetchLidarData() {
                try {
                    const response = await fetch("/lidar/data");
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                } catch (error) {
                    console.error(
                        "There has been a problem with your fetch operation:",
                        error
                    );
                }
            }

            let chartInstance = null; // Holds the chart instance

            async function drawPolarPlot() {
                const lidarData = await fetchLidarData();
                if (!lidarData) return;

                // Transform the data for the radar chart
                const labels = lidarData.map((point) => Math.round(point[0])); // Rounded angles
                const dataPoints = lidarData.map((point) => point[1]); // Distances

                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: "LIDAR Data Points",
                            data: dataPoints,
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 0, // No lines
                            pointBackgroundColor: "rgba(255, 99, 132, 1)",
                            pointBorderColor: "rgba(255, 99, 132, 1)",
                            pointRadius: 3, // Size of the points
                        },
                    ],
                };

                const config = {
                    type: "radar",
                    data: data,
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                suggestedMin: 0, // Adjust based on your data's minimum expected value
                                suggestedMax: 2500, // Adjust based on your data's maximum expected value
                                angleLines: {
                                    display: true,
                                },
                                grid: {
                                    circular: true,
                                },
                            },
                        },
                        elements: {
                            line: {
                                borderWidth: 0, // Ensure no lines are drawn
                            },
                            point: {
                                radius: 3, // Size of the points
                            },
                        },
                        animation: false, // Disable animation
                        plugins: {
                            legend: {
                                display: false, // Adjust based on your preference
                            },
                        },
                        // Set the start angle to -90 degrees to align 0 degrees at the top
                        startAngle: 0,
                    },
                };

                // Destroy the existing chart instance if it exists
                if (chartInstance) {
                    chartInstance.destroy();
                }

                // Create a new chart instance
                chartInstance = new Chart(
                    document.getElementById("polarPlot"),
                    config
                );
            }

            drawPolarPlot();

            // Refresh the plot every 100 ms
            setInterval(drawPolarPlot, 100);
        </script>
    </body>
</html>
