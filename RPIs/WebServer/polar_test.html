<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LIDAR Polar Scatter Plot</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <canvas id="polarPlot" width="400" height="400"></canvas>
        <script>
            async function fetchLidarData() {
                try {
                    const response = await fetch("/lidar/data");
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                } catch (error) {
                    console.error(
                        "There has been a problem with your fetch operation:",
                        error
                    );
                }
            }

            let chartInstance = null; // Holds the chart instance

            async function drawPolarPlot() {
                const lidarData = await fetchLidarData();
                if (!lidarData) return;

                const completeData = new Array(360).fill(null); // Initialize an array for all angles with null values

                lidarData.forEach((point) => {
                    const angle = Math.round(point[0]);
                    if (angle >= 0 && angle < 360) {
                        completeData[angle] = point[1];
                    }
                });

                const labels = completeData.map((_, index) => index);
                const dataPoints = completeData;

                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: "LIDAR Data Points",
                            data: dataPoints,
                            backgroundColor: "rgba(255, 99, 132, 0)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 0,
                            pointBackgroundColor: "rgba(255, 99, 132, 1)",
                            pointBorderColor: "rgba(255, 99, 132, 1)",
                            pointRadius: 3,
                        },
                    ],
                };

                const config = {
                    type: "radar",
                    data: data,
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                suggestedMin: 0,
                                suggestedMax: 2500,
                                angleLines: {
                                    display: true,
                                },
                                grid: {
                                    circular: true,
                                },
                            },
                        },
                        elements: {
                            line: {
                                borderWidth: 0,
                            },
                            point: {
                                radius: 3,
                            },
                        },
                        animation: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                        },
                        startAngle: 0,
                    },
                };

                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(
                    document.getElementById("polarPlot"),
                    config
                );
            }

            drawPolarPlot();

            // Refresh the plot every 100 ms
            setInterval(drawPolarPlot, 100);
        </script>
    </body>
</html>
